<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gerenciamento Admin</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/vue@3"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

    <style>
        /* ========================================
        CSS COMPLETO E RESPONSIVO
        ========================================
        */

        /* IMPORTA√á√ÉO DE FONTES */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');

        /* VARI√ÅVEIS DE TEMA */
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --bg-light: #f8f9fa;
            --text-dark: #343a40;
            --card-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.05);
            --border-radius: 0.5rem;
            --accent-light: #e9ecef;
            --login-bg: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        }

        /* ESTILOS BASE E LAYOUT */
        body { 
            font-family: 'Roboto', sans-serif; 
            background-color: var(--bg-light); 
            color: var(--text-dark); 
            margin: 0; 
            padding: 0;
            line-height: 1.6;
        }

        /* --- ESTRUTURA PARA ADMIN COM SIDEBAR --- */
        #app { 
            min-height: 100vh;
            display: flex;
            flex-direction: row; 
        }

        .login-container {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: var(--login-bg);
            padding: 20px;
            width: 100%;
        }
        
        .admin-layout {
            display: flex;
            width: 100%;
            min-height: 100vh;
        }

        .sidebar {
            width: 250px;
            background-color: var(--text-dark); 
            color: white;
            padding: 20px 0;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            z-index: 1000;
        }

        .sidebar h3 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.4em;
            font-weight: 700;
            color: var(--primary-color);
        }

        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1;
        }

        .nav-item a {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 20px;
            color: #ced4da;
            text-decoration: none;
            transition: background-color 0.3s, color 0.3s;
            cursor: pointer;
        }

        .nav-item a:hover {
            background-color: #495057;
            color: white;
        }

        .nav-item a.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: 500;
        }
        
        .sidebar .btn-logout-container {
            padding: 20px;
            margin-top: auto;
        }
        
        .main-content {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: var(--bg-light);
        }

        .admin-container { 
            max-width: 1300px; 
            margin: 20px auto; 
            padding: 30px; 
            background: #fff; 
            border-radius: var(--border-radius); 
            box-shadow: var(--card-shadow); 
            width: 100%;
            box-sizing: border-box;
        }

        h1 { color: var(--primary-color); font-size: 2.4em; font-weight: 700; margin-bottom: 5px; }
        h2 { 
            color: var(--text-dark); 
            border-bottom: 1px solid var(--accent-light); 
            padding-bottom: 15px; 
            margin-top: 40px; 
            margin-bottom: 25px;
            font-size: 1.8em; 
            font-weight: 500; 
        }
        
        .header { 
            display: flex; 
            flex-direction: column; 
            margin-bottom: 30px; 
            padding-bottom: 20px;
            border-bottom: 1px solid var(--accent-light);
        }
        
        .product-actions-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap; 
            align-items: center;
        }
        .product-actions-bar input:not([type="date"]) {
            flex-grow: 1; 
            padding: 10px; 
            border: 1px solid #ced4da; 
            border-radius: 4px; 
            min-width: 250px;
            font-size: 1em;
        }
        .product-actions-bar input[type="date"] {
            padding: 10px; 
            border: 1px solid #ced4da; 
            border-radius: 4px; 
            font-size: 1em;
        }

        /* ESTILOS DE BOT√ÉO */
        .btn { 
            padding: 10px 20px; 
            border: none; 
            border-radius: var(--border-radius); 
            cursor: pointer; 
            transition: all 0.3s ease; 
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            text-align: center;
        }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #0056b3; transform: translateY(-1px); }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover:not(:disabled) { background-color: #bd2130; transform: translateY(-1px); }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-success:hover:not(:disabled) { background-color: #1e7e34; transform: translateY(-1px); }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-secondary:hover:not(:disabled) { background-color: #5a6268; transform: translateY(-1px); }
        .btn-outline { 
            background: none; 
            border: 1px solid var(--secondary-color);
            color: var(--secondary-color);
            padding: 9px 19px; 
        }
        .btn-outline:hover:not(:disabled) { background: var(--secondary-color); color: white; }
        .btn-group { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        .btn-group-sm button { padding: 8px 10px; font-size: 0.9em; }


        /* ESTILOS DE FORMUL√ÅRIO GERAL */
        .register-form {
            padding: 30px;
            border: 1px solid #e9ecef; 
            border-radius: var(--border-radius); 
            margin: 20px auto; 
            background: #fff;
            box-shadow: var(--card-shadow);
            max-width: 600px;
        }
        .register-form input:not([type="file"]), .register-form textarea, .register-form input[type="number"], .register-form input[type="email"], .register-form input[type="password"] { 
            width: 100%; 
            padding: 12px; 
            margin-bottom: 15px; 
            border: 1px solid #ced4da; 
            border-radius: 4px; 
            box-sizing: border-box; 
            font-size: 1em;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .register-form input:focus, .register-form textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
            outline: none;
        }
        .register-form label { font-weight: 500; margin-top: 15px; display: block; color: var(--text-dark); margin-bottom: 5px;}
        
        /* ESTILOS DE LOGIN */
        .auth-form { 
            padding: 40px; 
            border-radius: var(--border-radius); 
            background: #fff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            max-width: 400px;
            width: 100%;
            text-align: center;
            box-sizing: border-box;
        }
        .auth-form h2 {
            border-bottom: none; 
            padding-bottom: 0; 
            margin-top: 0;
            margin-bottom: 30px;
            font-size: 2em;
            font-weight: 600;
        }
        .auth-form input { 
            width: 100%; 
            padding: 12px; 
            margin-bottom: 20px;
            border: 1px solid #ced4da; 
            border-radius: 4px; 
            box-sizing: border-box; 
            font-size: 1em;
        }
        .auth-form .btn-primary { width: 100%; font-size: 1.1em; padding: 12px 20px; }

        /* PR√â-VISUALIZA√á√ÉO DE IMAGEM E PROGRESS BAR */
        .preview-img { max-width: 250px; height: auto; display: block; margin: 10px 0 20px 0; border: 1px solid #ddd; border-radius: var(--border-radius); object-fit: contain; }
        .progress-bar { height: 10px; background-color: var(--accent-light); border-radius: 5px; overflow: hidden; margin: 10px 0 20px 0; }
        .progress { height: 100%; background-color: var(--success-color); transition: width 0.4s ease; }

        /* GRID DE PRODUTOS */
        .product-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px; 
            margin-top: 15px; 
        }
        .product-card { 
            border: 1px solid #e0e0e0; 
            border-radius: var(--border-radius); 
            overflow: hidden; 
            box-shadow: var(--card-shadow); 
            transition: transform 0.3s, box-shadow 0.3s; 
            display: flex; 
            flex-direction: column; 
            background: #fff; 
        }
        .product-card:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 1rem 2rem rgba(0, 0, 0, 0.08); 
        }
        
        .product-card img { 
            width: 100%; 
            height: 200px; 
            object-fit: contain; 
            border-bottom: 1px solid #eee; 
            background-color: #f8f9fa; 
        }
        
        .product-info { 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            flex-grow: 1; 
            justify-content: space-between; 
        }
        .product-info h3 { margin-top: 0; font-size: 1.2em; font-weight: 500; color: var(--text-dark); }
        .price { font-weight: 700; color: var(--primary-color); font-size: 1.3em; margin: 5px 0 15px 0; }
        .product-info .btn-group { display: flex; gap: 8px; margin-top: 10px; }
        .product-info .btn-group button { flex: 1; padding: 8px 10px; font-size: 0.9em; }

        /* LISTA DE PEDIDOS */
        .orders-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); 
            gap: 25px; 
            margin-top: 30px; 
        }
        .order-card { 
            border: 1px solid #e0e0e0; 
            border-radius: var(--border-radius); 
            padding: 20px; 
            box-shadow: var(--card-shadow); 
            background: #fff; 
            display: flex; 
            flex-direction: column; 
            transition: border-color 0.3s;
        }
        .order-card h3 { color: var(--secondary-color); margin-top: 0; font-weight: 600; border-bottom: 1px dashed var(--accent-light); padding-bottom: 10px; margin-bottom: 15px; font-size: 1.3em; }
        .order-total { font-size: 1.5em; font-weight: 700; color: var(--success-color); margin: 15px 0; }
        .order-items { margin-bottom: 20px; padding: 10px; border: 1px solid var(--accent-light); border-radius: 4px; flex-grow: 1; }
        .order-items h4 { font-size: 1em; margin-top: 0; color: var(--secondary-color); font-weight: 500;}
        .order-items ul { list-style: none; padding: 0; margin: 0;}
        .order-items li { background: var(--bg-light); padding: 8px 10px; margin-bottom: 5px; border-radius: 3px; font-size: 0.95em; }
        .order-card .customer-info { margin-bottom: 15px; }

        /* MENSAGENS DE FEEDBACK */
        .msg-error { background-color: #f8d7da; color: var(--danger-color); padding: 15px; border-left: 5px solid var(--danger-color); border-radius: var(--border-radius); margin-top: 20px; font-weight: 500; }
        .msg-success { background-color: #d4edda; color: #155724; padding: 15px; border-left: 5px solid var(--success-color); border-radius: var(--border-radius); margin-top: 20px; font-weight: 500; }
        
        /* ESTILOS DE RELAT√ìRIO (GR√ÅFICO E TABELA) */
        .reports-container {
            /* ALTERA√á√ÉO AQUI: Garante que os itens fiquem um abaixo do outro */
            display: flex;
            flex-direction: column; 
            gap: 25px; 
            margin-top: 20px;
        }
        
        .card { 
            background: #fff; 
            border-radius: var(--border-radius); 
            box-shadow: var(--card-shadow); 
            padding: 20px;
        }

        .chart-card {
            /* Garante que o gr√°fico ocupe a largura total */
            width: 100%; 
        }
        
        .data-table-card {
            /* Garante que a tabela ocupe a largura total */
            width: 100%; 
            min-height: auto;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9em;
        }

        .report-table th, .report-table td {
            padding: 10px;
            text-align: right;
            border-bottom: 1px solid var(--accent-light);
        }
        
        .report-table th:first-child, .report-table td:first-child {
            text-align: left;
            font-weight: 500;
        }

        .report-table th {
            background-color: var(--accent-light);
            font-weight: 700;
            color: var(--text-dark);
            text-transform: uppercase;
        }
        
        /* Rodap√© da tabela para totais */
        .report-table tfoot td {
            border-top: 2px solid var(--primary-color);
            border-bottom: none;
            font-size: 1em;
            padding: 12px 10px;
        }


        /* Estilos de texto para cores espec√≠ficas (utilizados na tabela) */
        .text-primary { color: var(--primary-color); font-weight: 700; }
        .text-danger { color: var(--danger-color); font-weight: 700; }
        .text-success { color: var(--success-color); font-weight: 700; }
        
        
        /* --- MEDIA QUERIES PARA RESPONSIVIDADE EM CELULAR --- */
        @media (max-width: 768px) {
            
            /* Layout Geral */
            .admin-container { 
                margin: 0; 
                padding: 15px; 
                border-radius: 0; 
                box-shadow: none; 
            } 
            .login-container { padding: 15px; }

            /* Tipografia */
            h1 { font-size: 1.8em; }
            h2 { font-size: 1.4em; margin-top: 30px; margin-bottom: 15px; }

            /* Sidebar no Mobile */
            .admin-layout {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: auto;
                padding: 10px 0;
                position: static;
                box-shadow: none;
                border-bottom: 1px solid #495057;
            }
            .sidebar h3 {
                display: none;
            }
            .nav-list {
                display: flex;
                justify-content: space-around;
                flex-wrap: wrap;
                gap: 10px;
            }
            .nav-item {
                flex-grow: 1;
                text-align: center;
            }
            .nav-item a {
                padding: 10px 15px;
                flex-direction: column;
                gap: 5px;
                font-size: 0.8em;
                justify-content: center;
            }
            .sidebar .btn-logout-container {
                display: none;
            }
            .main-content {
                padding: 0;
            }
            
            /* Barra de A√ß√µes e Busca */
            .product-actions-bar {
                flex-direction: column;
                gap: 15px;
            }
            .product-actions-bar .btn-success {
                width: 100%;
                justify-content: center;
                order: -1;
            }
            .product-actions-bar input {
                width: 100%;
                min-width: 100%;
            }

            /* Formul√°rios */
            .auth-form { padding: 30px 20px; }
            .register-form { 
                padding: 20px; 
                margin: 10px 0; 
                max-width: 100%; 
            }
            
            /* Grupos de Bot√µes */
            .btn-group { 
                flex-direction: column;
                gap: 8px; 
            }
            .btn-group button { 
                width: 100%; 
            }

            /* Grids */
            .product-grid {
                grid-template-columns: 1fr; 
                gap: 15px;
            }
            .product-card img { height: 150px; }

            .orders-list {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            /* Relat√≥rios no Mobile: Empilha o Gr√°fico e a Tabela */
            .reports-container {
                flex-direction: column;
                gap: 15px;
            }
            .chart-card, .data-table-card {
                flex: none; /* Remove a propor√ß√£o fixa */
                width: 100%;
                min-height: auto;
            }
        }
        
        /* Regras aplicadas para telas menores que 576px (Celular Extremo) */
        @media (max-width: 576px) {
            .btn { padding: 8px 15px; font-size: 0.9em; }
            h1 { font-size: 1.6em; }
            h2 { font-size: 1.3em; }
            .product-card .btn-group button { font-size: 0.8em; padding: 6px 8px; }
            .btn-group-sm button { font-size: 0.8em; padding: 6px 8px; }
            .btn-group { gap: 5px; } /* Ajuste de gap para caber mais bot√µes */
        }
    </style>
</head>
<body>
    <div id="app">
        
        <div v-if="!user" class="login-container">
            <form @submit.prevent="handleLogin" class="auth-form">
                <h2>Acesso Administrador</h2>
                <input type="email" v-model="email" placeholder="Email" required>
                <input type="password" v-model="password" placeholder="Senha" required>
                <button type="submit" class="btn btn-primary" :disabled="isLoading">
                    {{ isLoading ? 'Entrando...' : 'Entrar' }}
                </button>
                <p v-if="error" class="msg-error">{{ error }}</p>
            </form>
        </div>

        <div v-else class="admin-layout">
            
            <div class="sidebar">
                <h3>Admin Painel</h3>
                
                <ul class="nav-list">
                    <li class="nav-item">
                        <a :class="{ active: currentView === 'admin' }" @click="resetFormAndNavigate('admin')">
                            üõí Produtos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a :class="{ active: currentView === 'orders' }" @click="resetFormAndNavigate('orders')">
                            üìù Pedidos ({{ orders.length }})
                        </a>
                    </li>
                    <li class="nav-item">
                        <a :class="{ active: currentView === 'reports' }" @click="resetFormAndNavigate('reports')">
                            üìä Relat√≥rios
                        </a>
                    </li>
                    <li class="nav-item">
                        <a :class="{ active: currentView === 'admin-register' }" @click="resetFormAndNavigate('admin-register')">
                            üë§ Cadastro Admin
                        </a>
                    </li>
                </ul>

                <div class="btn-logout-container">
                     <button @click="handleLogout" class="btn btn-danger" style="width: 100%;">
                        Sair ({{ user ? user.email : 'Admin'¬†}})
                    </button>
                </div>
            </div>
            
            <div class="main-content">
                <div class="admin-container">
                    
                    <p v-if="globalSuccess" class="msg-success">{{ globalSuccess }}</p>
                    <p v-if="globalError" class="msg-error">{{ globalError }}</p>

                    
                    <div v-if="currentView === 'admin'">
                        <div class="header">
                            <h1>Gest√£o de Produtos</h1>
                        </div>
                        
                        <div class="product-actions-bar">
                            <button @click="resetFormAndNavigate('register')" class="btn btn-success">
                                ‚ûï Novo Produto
                            </button>
                            <input type="text" v-model="searchTerm" placeholder="Buscar por nome..." @input="fetchProducts">
                        </div>

                        <div v-if="isDataLoading">
                            <p>Carregando produtos...</p>
                        </div>
                        <div v-else-if="filteredProducts.length > 0" class="product-grid">
                            <div v-for="product in filteredProducts" :key="product.id" class="product-card">
                                <img :src="product.imageUrl" :alt="product.name">
                                <div class="product-info">
                                    <div>
                                        <h3>{{ product.name }}</h3>
                                    </div>
                                    <div class="product-actions-group">
                                        <p class="price">{{ formatPrice(product.price) }}</p>
                                        <div class="btn-group">
                                            <button @click="startEdit(product)" class="btn btn-primary">Editar</button>
                                            <button @click="handleProductDelete(product.id, product.imageUrl)" class="btn btn-danger">Excluir</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <p v-else>Nenhum produto cadastrado ou encontrado.</p>
                    </div>
                    
                    <div v-else-if="currentView === 'reports'">
                        <div class="header">
                            <h1>Relat√≥rios de Vendas</h1>
                        </div>
                        
                        <div class="product-actions-bar" style="margin-bottom: 25px; align-items: center;">
                            <label for="startDate" style="font-weight: 500; margin-right: 5px;">De:</label>
                            <input type="date" id="startDate" v-model="startDate" style="max-width: 200px;" @change="updateReports">
                            
                            <label for="endDate" style="font-weight: 500; margin-right: 5px;">At√©:</label>
                            <input type="date" id="endDate" v-model="endDate" style="max-width: 200px;" @change="updateReports">
                            
                            <button @click="clearDateFilters" class="btn btn-secondary" :disabled="!startDate && !endDate">Limpar Filtros</button>
                        </div>
                        <div class="reports-container">
                            
                            <div class="card chart-card">
                                <h2>Contagem Mensal: Pedidos Enviados vs. Cancelados</h2>
                                <div style="height: 400px; width: 100%;"> 
                                    <chart-component 
                                        :chart-data="monthlyOrdersData" 
                                        chart-type="bar" 
                                        chart-title="Contagem de Pedidos por M√™s e Status">
                                    </chart-component>
                                </div>
                            </div>
                            
                            <div class="card data-table-card">
                                <h2>Itens Mais Vendidos (Enviados/Conclu√≠dos)</h2>
                                <table class="report-table">
                                    <thead>
                                        <tr>
                                            <th style="text-align: left;">Item</th>
                                            <th>Vendido</th>
                                            <th>Valor Unit.</th>
                                            <th>Valor Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="item in topSellingItems" :key="item.name">
                                            <td style="text-align: left;">{{ item.name }}</td>
                                            <td class="text-primary">{{ item.quantity }}</td>
                                            <td>{{ formatPrice(item.unitPrice) }}</td>
                                            <td class="text-success">{{ formatPrice(item.revenue) }}</td>
                                        </tr>
                                    </tbody>
                                    <tfoot v-if="topSellingItems.length > 0">
                                        <tr>
                                            <td colspan="3" style="text-align: right; font-weight: 700; background-color: var(--accent-light);">
                                                TOTAL GERAL VENDIDO:
                                            </td>
                                            <td class="text-success" style="background-color: var(--accent-light); font-size: 1.1em;">
                                                {{ formatPrice(totalRevenue) }}
                                            </td>
                                        </tr>
                                    </tfoot>
                                    </table>
                                <p v-if="topSellingItems.length === 0" style="text-align: center; margin-top: 20px; color: var(--secondary-color);">
                                    Sem dados de vendas (Pedidos "Enviados" ou "Conclu√≠dos" necess√°rios).
                                </p>
                            </div>
                        </div>
                        </div>

                    <div v-else-if="currentView === 'orders'">
                        <div class="header">
                            <h1>Pedidos Recebidos (Total: {{ orders.length }})</h1>
                        </div>
                        
                        <div class="btn-group" style="margin-top: 0; margin-bottom: 25px;">
                            <button 
                                @click="orderFilter = 'Todos'" 
                                :class="{ 'btn-primary': orderFilter === 'Todos', 'btn-outline': orderFilter !== 'Todos' }" 
                                class="btn">
                                Todos
                            </button>
                            <button 
                                @click="orderFilter = 'Processando'" 
                                :class="{ 'btn-primary': orderFilter === 'Processando', 'btn-outline': orderFilter !== 'Processando' }" 
                                class="btn">
                                Processando
                            </button>
                            <button 
                                @click="orderFilter = 'Enviado'" 
                                :class="{ 'btn-primary': orderFilter === 'Enviado', 'btn-outline': orderFilter !== 'Enviado' }" 
                                class="btn">
                                Enviados
                            </button>
                            <button 
                                @click="orderFilter = 'Cancelado'" 
                                :class="{ 'btn-primary': orderFilter === 'Cancelado', 'btn-outline': orderFilter !== 'Cancelado' }" 
                                class="btn">
                                Cancelados
                            </button>
                            <button 
                                @click="orderFilter = 'Conclu√≠do'" 
                                :class="{ 'btn-primary': orderFilter === 'Conclu√≠do', 'btn-outline': orderFilter !== 'Conclu√≠do' }" 
                                class="btn">
                                Conclu√≠dos
                            </button>
                        </div>
                        <div v-if="isOrdersLoading">
                            <p>Carregando pedidos...</p>
                        </div>
                        <div v-else-if="filteredOrders.length > 0" class="orders-list">
                            <div v-for="order in filteredOrders" :key="order.id" class="order-card">
                                <h3>Pedido #{{ order.id.substring(0, 8).toUpperCase() }}</h3>
                                
                                <div class="customer-info">
                                    <p><strong>Cliente:</strong> {{ order.customer.name }}</p>
                                    <p><strong>Email:</strong> {{ order.customer.email }}</p>
                                    <p v-if="order.customer.whatsapp">
                                        <strong>Whatsapp:</strong> 
                                        <a :href="'https://wa.me/55' + order.customer.whatsapp.replace(/[^0-9]/g, '')" target="_blank" style="color: var(--success-color); font-weight: 500;">
                                            {{ order.customer.whatsapp }} 
                                        </a>
                                    </p>
                                    <p>
                                        <strong>Endere√ßo:</strong> 
                                        {{ order.customer.address.street }}, {{ order.customer.address.number }} - {{ order.customer.address.city }} 
                                        <span v-if="order.customer.address.complement">({{ order.customer.address.complement }})</span>
                                    </p>
                                </div>
                                
                                <p><strong>Data do Pedido:</strong> {{ formatDate(order.date) }}</p>
                                <p>
                                    <strong>Status:</strong> 
                                    <span 
                                        :style="{ 
                                            fontWeight: '700',
                                            color: order.status === 'Enviado' ? 'var(--primary-color)' : (order.status === 'Cancelado' ? 'var(--danger-color)' : (order.status === 'Conclu√≠do' ? 'var(--success-color)' : 'var(--secondary-color)')) 
                                        }">
                                        {{ order.status || 'Processando' }}
                                    </span>
                                </p>
                                
                                <p v-if="order.dateSent">
                                    <strong>üì¶ Enviado em:</strong> 
                                    <span style="color: var(--primary-color); font-weight: 500;">{{ order.dateSent }}</span>
                                </p>
                                <p v-if="order.dateCanceled">
                                    <strong>‚ùå Cancelado em:</strong> 
                                    <span style="color: var(--danger-color); font-weight: 500;">{{ order.dateCanceled }}</span>
                                </p>
                                <p v-if="order.dateConcluded">
                                    <strong>‚úÖ Conclu√≠do em:</strong> 
                                    <span style="color: var(--success-color); font-weight: 500;">{{ order.dateConcluded }}</span>
                                </p>

                                <div class="order-items">
                                    <h4>Itens ({{ order.items ? order.items.length : 0 }})</h4>
                                    <ul>
                                        <li v-for="item in order.items">
                                            {{ item.name }} (x{{ item.quantity }}) - {{ formatPrice(item.price * item.quantity) }}
                                        </li>
                                    </ul>
                                </div>
                                
                                <p class="order-total">Total: {{ formatPrice(order.total) }}</p>
                                
                                <div class="btn-group btn-group-sm" style="margin-top: 10px; flex-direction: column; gap: 8px;">
                                    <button 
                                        @click="updateOrderStatus(order, 'Enviado')" 
                                        class="btn btn-primary"
                                        :disabled="order.status === 'Enviado' || order.status === 'Conclu√≠do'">
                                        Marcar como Enviado
                                    </button>
                                    
                                    <button 
                                        @click="updateOrderStatus(order, 'Cancelado')" 
                                        class="btn btn-secondary"
                                        :disabled="order.status === 'Cancelado' || order.status === 'Conclu√≠do'">
                                        Marcar como Cancelado
                                    </button>

                                    <button 
                                        @click="updateOrderStatus(order, 'Conclu√≠do')" 
                                        class="btn btn-success"
                                        :disabled="order.status === 'Conclu√≠do'">
                                        Marcar como Conclu√≠do
                                    </button>
                                    
                                    <button 
                                        @click="handleOrderDelete(order.id, order.clientUid)" 
                                        class="btn btn-danger">
                                        Excluir Permanentemente do DB
                                    </button>
                                </div>
                            </div>
                        </div>
                        <p v-else>Nenhum pedido encontrado com o filtro atual ({{ orderFilter }}).</p>
                    </div>

                    <div v-else-if="currentView === 'register'">
                        <div class="header">
                            <h1>{{ isEditing ? 'Editar Produto' : 'Cadastrar Novo Produto' }}</h1>
                        </div>

                        <form @submit.prevent="isEditing ? handleProductUpdate() : handleProductRegister()" class="register-form">
                            <label>Nome do Produto:</label>
                            <input type="text" v-model="newProduct.name" required>

                            <label>Pre√ßo (R$):</label>
                            <input type="number" v-model.number="newProduct.price" step="0.01" min="0.01" required>

                            <label>Imagem (apenas para Novo Cadastro ou Mudan√ßa):</label>
                            <input type="file" @change="handleFileChange" accept="image/*">
                            
                            <div v-if="imagePreviewUrl || newProduct.imageUrl">
                                <p>Pr√©-visualiza√ß√£o:</p>
                                <img :src="imagePreviewUrl || newProduct.imageUrl" class="preview-img" alt="Pr√©-visualiza√ß√£o do Produto">
                            </div>
                            
                            <div v-if="isRegistering && uploadProgress > 0 && uploadProgress < 100" class="progress-bar">
                                <div class="progress" :style="{ width: uploadProgress + '%' }"></div>
                            </div>
                            
                            <div class="btn-group">
                                <button type="submit" class="btn btn-success" :disabled="isRegistering || (isEditing && !newProduct.name)">
                                    {{ isRegistering ? 'Processando...' : (isEditing ? 'Salvar Altera√ß√µes' : 'Cadastrar Produto') }}
                                </button>
                                <button type="button" @click="resetFormAndNavigate('admin')" class="btn btn-secondary" :disabled="isRegistering">
                                    Cancelar
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <div v-else-if="currentView === 'admin-register'">
                        <div class="header">
                            <h1>Cadastro de Novo Usu√°rio Admin</h1>
                        </div>
                        <form @submit.prevent="handleAdminRegister" class="register-form">
                            <label>Email:</label>
                            <input type="email" v-model="newAdmin.email" required>
                            
                            <label>Senha (m√≠nimo 6 caracteres):</label>
                            <input type="password" v-model="newAdmin.password" required>
                            
                            <button type="submit" class="btn btn-primary" :disabled="isRegistering">
                                {{ isRegistering ? 'Cadastrando...' : 'Cadastrar Novo Admin' }}
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // CONFIGURA√á√ÉO DO FIREBASE
        // **SUBSTITUA PELAS SUAS PR√ìPRIAS CHAVES DE CONFIGURA√á√ÉO**
        const firebaseConfig = {
             apiKey: "AIzaSyAnGyAYBthXQs5rEylnLXCxOVQKKN1FP34",
             authDomain: "grafica-619fd.firebaseapp.com",
             databaseURL: "https://grafica-619fd-default-rtdb.firebaseio.com",
             projectId: "grafica-619fd",
             storageBucket: "grafica-619fd.firebasestorage.app",
             messagingSenderId: "1022124441596",
             appId: "1:1022124441596:web:d6f25056f38a6babc67c79",
             measurementId: "G-SQ4QNTFXCM"
        };

        // Inicializa o Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();
        
        const { createApp, ref, onMounted, computed, watch, onUnmounted } = Vue;

        // ----------------------------------------------------
        // COMPONENTE VUE PARA CHART.JS
        // ----------------------------------------------------
        const ChartComponent = {
            props: {
                chartData: Object,
                chartType: {
                    type: String,
                    default: 'bar'
                },
                chartTitle: {
                    type: String,
                    default: 'Gr√°fico'
                }
            },
            template: `
                <div>
                    <canvas ref="chartCanvas"></canvas>
                    <p v-if="hasNoData" style="padding: 20px; text-align: center; color: var(--secondary-color);">
                        Dados insuficientes para gerar o gr√°fico.
                    </p>
                </div>
            `,
            setup(props) {
                const chartCanvas = ref(null);
                let myChart = null; 

                const hasNoData = computed(() => {
                    return !props.chartData.labels || props.chartData.labels.length === 0;
                });
                
                const renderChart = () => {
                    if (!chartCanvas.value || hasNoData.value) {
                        if (myChart) myChart.destroy();
                        return;
                    }

                    // Destruir inst√¢ncia anterior
                    if (myChart) {
                        myChart.destroy();
                    }

                    const ctx = chartCanvas.value.getContext('2d');
                    myChart = new Chart(ctx, {
                        type: props.chartType, 
                        data: props.chartData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false, // Permite definir altura/largura via CSS
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'N¬∫ de Pedidos'
                                    },
                                    ticks: {
                                        // Garante que o eixo Y mostre apenas n√∫meros inteiros
                                        callback: function(value) { if (value % 1 === 0) { return value; } return null; } 
                                    }
                                },
                                // Configura√ß√£o para o eixo X (Gr√°fico de Barras Vertical)
                                x: {
                                    stacked: false, // Garante que as barras Enviado/Cancelado fiquem lado a lado
                                }
                            },
                            plugins: {
                                legend: {
                                    display: true, // EXIBE A LEGENDA
                                    position: 'top',
                                },
                                title: {
                                    display: true,
                                    text: props.chartTitle,
                                    font: { size: 16, weight: 'bold' }
                                }
                            }
                        }
                    });
                };

                // Observa mudan√ßas nos dados para redesenhar
                watch(() => props.chartData, () => {
                    renderChart();
                }, { deep: true });

                onMounted(() => {
                    renderChart();
                });

                onUnmounted(() => {
                    if (myChart) {
                        myChart.destroy();
                    }
                });

                return {
                    chartCanvas,
                    hasNoData
                };
            }
        };
        // ----------------------------------------------------
        // FIM COMPONENTE VUE PARA CHART.JS
        // ----------------------------------------------------


        // ----------------------------------------------------
        // INICIALIZA√á√ÉO DO VUE 3
        // ----------------------------------------------------

        const app = createApp({
            setup() {
                // --- 1. ESTADOS REATIVOS ---
                const user = ref(null);
                const email = ref('');
                const password = ref('');
                const error = ref(null);
                const isLoading = ref(false); 
                const currentView = ref('login'); 
                const globalSuccess = ref(null); 
                const globalError = ref(null); 
                
                // Produtos
                const products = ref([]);
                const isDataLoading = ref(false); 
                const newProduct = ref({ id: null, name: '', price: 0.00, imageUrl: '' }); 
                const searchTerm = ref('');
                
                // Imagens
                const imageFile = ref(null);
                const uploadProgress = ref(0);
                const imagePreviewUrl = ref(''); 
                
                // Pedidos
                const orders = ref([]);
                const isOrdersLoading = ref(false); 
                const orderFilter = ref('Todos'); 
                
                // Dados para Relat√≥rios
                const monthlyOrdersData = ref({ labels: [], datasets: [] });
                const topSellingItems = ref([]); 
                
                // Filtros de Data para Relat√≥rios (NOVOS ESTADOS)
                const startDate = ref(''); 
                const endDate = ref(''); 
                
                // Admin Register
                const isRegistering = ref(false); 
                const newAdmin = ref({ email: '', password: '' });

                // --- 2. PROPRIEDADES COMPUTADAS ---
                const isEditing = computed(() => newProduct.value.id !== null);
                
                const filteredProducts = computed(() => {
                    const term = searchTerm.value.toLowerCase().trim();
                    if (!term) return products.value;
                    
                    return products.value.filter(product => {
                        return product.name.toLowerCase().includes(term);
                    });
                });

                // Propriedade computada para filtrar pedidos (na view 'orders')
                const filteredOrders = computed(() => {
                    const filter = orderFilter.value;
                    
                    return orders.value.filter(order => {
                        // Assume 'Processando' se o status for nulo/indefinido
                        const orderStatus = order.status || 'Processando'; 
                        
                        if (filter === 'Todos') return true;
                        
                        return orderStatus === filter;
                    });
                });
                
                // Calcula o Valor Total de Vendas dos itens listados
                const totalRevenue = computed(() => {
                    return topSellingItems.value.reduce((sum, item) => sum + item.revenue, 0);
                });
                
                // NOVO: Propriedade computada para filtrar pedidos para relat√≥rios (por data)
                const filteredOrdersForReport = computed(() => {
                    let filteredList = orders.value;
                    
                    // Converte datas de input (YYYY-MM-DD) para objetos Date no fuso 00:00 e 23:59
                    const start = startDate.value ? new Date(startDate.value + 'T00:00:00') : null;
                    const end = endDate.value ? new Date(endDate.value + 'T23:59:59') : null;

                    if (!start && !end) return filteredList;

                    return filteredList.filter(order => {
                        const orderDateObj = getDateObjectFromOrderString(order.date);
                        if (!orderDateObj) return false;

                        const orderTime = orderDateObj.getTime();
                        let pass = true;

                        // Filtra pela Data Inicial (De)
                        if (start && orderTime < start.getTime()) {
                            pass = false;
                        }

                        // Filtra pela Data Final (At√©)
                        if (end && orderTime > end.getTime()) {
                            pass = false;
                        }

                        return pass;
                    });
                });


                // --- 3. M√âTODOS DE UTILIDADE E FEEDBACK ---

                const clearFeedback = () => {
                    globalSuccess.value = null;
                    globalError.value = null;
                    error.value = null;
                };

                const setFeedback = (type, message) => {
                    clearFeedback();
                    if (type === 'success') {
                        globalSuccess.value = message;
                    } else if (type === 'error') {
                        globalError.value = message;
                    } else if (type === 'loginError') {
                        error.value = message;
                    }
                    setTimeout(clearFeedback, 4000);
                };

                const formatPrice = (value) => {
                    const num = parseFloat(value);
                    if (isNaN(num)) return 'R$ 0,00';
                    return 'R$ ' + num.toFixed(2).replace('.', ',');
                };

                const getDateObjectFromOrderString = (dateString) => {
                    // Expected format: 'dd/mm/yyyy, hh:mm:ss'
                    const parts = String(dateString).match(/(\d{2})\/(\d{2})\/(\d{4}), (\d{2}):(\d{2}):(\d{2})/);
                    if (parts) {
                        // Construct ISO format string 'YYYY-MM-DDTHH:mm:ss'
                        const isoString = `${parts[3]}-${parts[2]}-${parts[1]}T${parts[4]}:${parts[5]}:${parts[6]}`;
                        const date = new Date(isoString);
                        return isNaN(date.getTime()) ? null : date;
                    }
                    // Fallback for standard timestamp (e.g., if dateString is already a timestamp)
                    const fallbackDate = new Date(dateString);
                    return isNaN(fallbackDate.getTime()) ? null : fallbackDate;
                };

                const formatDate = (timestamp) => {
                    if (!timestamp) return 'N/A';
                    
                    const date = getDateObjectFromOrderString(timestamp);
                    
                    if (date) {
                        return date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR');
                    }
                    
                    return 'Data Inv√°lida';
                };


                const resetForm = () => {
                    newProduct.value = { id: null, name: '', price: 0.00, imageUrl: '' };
                    imageFile.value = null;
                    imagePreviewUrl.value = '';
                    uploadProgress.value = 0;
                    newAdmin.value = { email: '', password: '' };
                    searchTerm.value = ''; 
                    orderFilter.value = 'Todos'; // Reinicia o filtro
                    startDate.value = ''; // NOVO
                    endDate.value = ''; // NOVO
                    
                    const fileInput = document.querySelector('input[type="file"]');
                    if (fileInput) fileInput.value = '';
                };

                const resetFormAndNavigate = (view) => {
                    clearFeedback();
                    resetForm();
                    currentView.value = view;

                    if (view === 'admin') fetchProducts();
                    if (view === 'orders' || view === 'reports') fetchOrders();
                };
                
                // NOVO: Limpa os filtros de data
                const clearDateFilters = () => {
                    startDate.value = '';
                    endDate.value = '';
                };


                // --- 4. M√âTODOS DE AUTENTICA√á√ÉO ---

                const handleLogin = async () => { 
                    isLoading.value = true;
                    clearFeedback();
                    try {
                        await auth.signInWithEmailAndPassword(email.value, password.value);
                        email.value = '';
                        password.value = '';
                    } catch (err) {
                        setFeedback('loginError', 'Falha no login. Verifique email/senha.');
                    } finally {
                        isLoading.value = false;
                    }
                };

                const handleLogout = async () => { 
                    await auth.signOut();
                    user.value = null;
                    currentView.value = 'login';
                    clearFeedback();
                    resetForm();
                };

                const handleAdminRegister = async () => {
                    isRegistering.value = true;
                    clearFeedback();
                    try {
                        await auth.createUserWithEmailAndPassword(newAdmin.value.email, newAdmin.value.password);
                        setFeedback('success', `Novo administrador (${newAdmin.value.email}) cadastrado com sucesso!`);
                        resetFormAndNavigate('admin');
                    } catch (err) {
                        let errorMessage = 'Falha ao cadastrar administrador.';
                        if (err.code === 'auth/email-already-in-use') errorMessage = 'O email j√° est√° em uso.';
                        else if (err.code === 'auth/weak-password') errorMessage = 'A senha deve ter no m√≠nimo 6 caracteres.';
                        else if (err.code === 'auth/invalid-email') errorMessage = 'O formato do email √© inv√°lido.';
                        setFeedback('error', errorMessage);
                        console.error("Erro ao cadastrar admin:", err);
                    } finally {
                        isRegistering.value = false;
                    }
                };


                // --- 5. M√âTODOS DE DADOS (FETCH) ---

                const fetchProducts = async () => {
                    isDataLoading.value = true;
                    try {
                        const snapshot = await database.ref('produtos').once('value'); 
                        const data = snapshot.val();
                        const productList = [];
                        if (data) {
                            for (let id in data) {
                                productList.push({ id, ...data[id], price: parseFloat(data[id].price || 0) });
                            }
                        }
                        products.value = productList.reverse();
                    } catch (err) {
                        console.error("Erro ao carregar produtos:", err);
                        setFeedback('error', 'Erro ao carregar a lista de produtos.');
                    } finally {
                        isDataLoading.value = false;
                    }
                };
                
                const fetchOrders = async () => {
                    isOrdersLoading.value = true;
                    try {
                        const snapshot = await database.ref('pedidos').once('value');
                        const data = snapshot.val();
                        const ordersList = [];
                        
                        if (data) {
                            for (let clientUid in data) {
                                const clientOrders = data[clientUid];
                                for (let orderId in clientOrders) {
                                    const orderData = clientOrders[orderId];
                                    ordersList.push({ 
                                        id: orderId, 
                                        clientUid: clientUid, 
                                        ...orderData, 
                                        total: parseFloat(orderData.total || 0),
                                        // Garante que items √© um array, tratando o caso de ser um objeto
                                        items: Array.isArray(orderData.items) ? orderData.items : (orderData.items ? Object.values(orderData.items) : []) 
                                    });
                                }
                            }
                        }
                        orders.value = ordersList.reverse(); 
                        
                        // updateReports() ser√° chamado pelo watcher de filteredOrdersForReport, 
                        // mas chamamos aqui explicitamente no primeiro carregamento
                        updateReports(); 
                        
                    } catch (err) {
                        console.error("Erro ao carregar pedidos:", err);
                        setFeedback('error', 'Erro ao carregar a lista de pedidos.');
                    } finally {
                        isOrdersLoading.value = false;
                    }
                };
                
                // --- M√âTODOS DE RELAT√ìRIOS ---
                
                // NOVO: M√©todo para reprocessar relat√≥rios
                const updateReports = () => {
                    // Se n√£o houver pedidos carregados, limpa os gr√°ficos/tabelas
                    if (orders.value.length === 0) {
                        monthlyOrdersData.value = { labels: [], datasets: [] };
                        topSellingItems.value = [];
                        return;
                    }
                    
                    // Usa a lista de pedidos filtrada pela data
                    const ordersToProcess = filteredOrdersForReport.value;
                    
                    processMonthlyOrders(ordersToProcess); 
                    processTopSellingItems(ordersToProcess);
                };
                
                // M√âTODOS DE GR√ÅFICOS (Contagem Mensal)
                const processMonthlyOrders = (ordersList) => {
                    // Armazena a contagem: 'YYYY-MM' -> { Enviado: count, Cancelado: count }
                    const monthlyData = {}; 
                    
                    ordersList.forEach(order => {
                        const status = order.status || 'Processando';
                        
                        // S√≥ nos interessam 'Enviado' e 'Cancelado'
                        if (status !== 'Enviado' && status !== 'Cancelado' && status !== 'Conclu√≠do') return; 
                        
                        const date = getDateObjectFromOrderString(order.date);
                        
                        if (!date) return; 
                        
                        // Formato 'YYYY-MM' para garantir a ordena√ß√£o correta e agrupar
                        const yearMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                        
                        if (!monthlyData[yearMonth]) {
                            monthlyData[yearMonth] = { 'Enviado': 0, 'Cancelado': 0 };
                        }
                        
                        // Conta 'Conclu√≠do' junto com 'Enviado' para fins de contagem de pedidos de sucesso
                        const key = (status === 'Conclu√≠do') ? 'Enviado' : status;
                        
                        // Incrementa a contagem para o status espec√≠fico
                        if (key in monthlyData[yearMonth]) {
                            monthlyData[yearMonth][key] += 1;
                        }
                    });

                    // Converte e ordena os dados
                    const sortedMonths = Object.keys(monthlyData).sort();
                    
                    // Labels do eixo X (Meses)
                    const labels = sortedMonths.map(ym => {
                        const [year, month] = ym.split('-');
                        const monthNames = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
                        return `${monthNames[parseInt(month) - 1]}/${year.substring(2)}`; // Ex: "Jan/25"
                    });

                    // Dados para cada barra
                    const shippedData = sortedMonths.map(ym => monthlyData[ym]['Enviado']);
                    const canceledData = sortedMonths.map(ym => monthlyData[ym]['Cancelado']);

                    monthlyOrdersData.value = {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Pedidos Enviados/Conclu√≠dos',
                                backgroundColor: '#007bff', // Azul
                                data: shippedData,
                                borderWidth: 1,
                                borderRadius: 5,
                            },
                            {
                                label: 'Pedidos Cancelados',
                                backgroundColor: '#dc3545', // Vermelho
                                data: canceledData,
                                borderWidth: 1,
                                borderRadius: 5,
                            }
                        ]
                    };
                };
                
                // M√âTODOS DE TABELA (Itens Mais Vendidos)
                const processTopSellingItems = (ordersList) => {
                    // Aggregation: { productName: { quantity: 0, revenue: 0, unitPrice: 0 } }
                    const itemsData = {}; 

                    ordersList.forEach(order => {
                        // S√≥ contabiliza itens de pedidos que foram 'Enviados' ou 'Conclu√≠dos'
                        const status = order.status || 'Processando';
                        if (status === 'Cancelado' || status === 'Processando') return; 
                        
                        const itemsArray = Array.isArray(order.items) ? order.items : (order.items ? Object.values(order.items) : []);
                        
                        itemsArray.forEach(item => {
                            const name = item.name;
                            const quantity = parseInt(item.quantity) || 0;
                            const price = parseFloat(item.price) || 0;
                            const totalItemValue = quantity * price;

                            if (name) {
                                if (!itemsData[name]) {
                                    itemsData[name] = { 
                                        name: name,
                                        quantity: 0, 
                                        revenue: 0, 
                                        unitPrice: price 
                                    };
                                }
                                itemsData[name].quantity += quantity;
                                itemsData[name].revenue += totalItemValue;
                            }
                        });
                    });

                    // Converte para array e ordena pela quantidade (mais vendidos primeiro)
                    const sortedItems = Object.values(itemsData)
                        .sort((a, b) => b.quantity - a.quantity); 

                    topSellingItems.value = sortedItems;
                };


                // --- 6. M√âTODOS DE PRODUTOS (CRUD) ---

                const handleFileChange = (event) => {
                    const file = event.target.files[0];
                    imageFile.value = file || null;
                    imagePreviewUrl.value = ''; 

                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => { imagePreviewUrl.value = e.target.result; };
                        reader.readAsDataURL(file);
                    }
                };

                const uploadImage = (file) => {
                    if (!file) return Promise.resolve(null);
                    
                    const fileName = `${Date.now()}_${file.name}`;
                    const storageRef = storage.ref(`images/${fileName}`);
                    const uploadTask = storageRef.put(file);

                    return new Promise((resolve, reject) => {
                        uploadTask.on('state_changed', 
                            (snapshot) => {
                                uploadProgress.value = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            }, 
                            (error) => {
                                reject(new Error("Falha no upload da imagem: " + error.message));
                            },
                            async () => {
                                const imageUrl = await storageRef.getDownloadURL();
                                resolve(imageUrl);
                            }
                        );
                    });
                };

                const deleteOldImage = async (oldImageUrl) => {
                    if (oldImageUrl && oldImageUrl.includes(storage.storageBucket)) {
                        try {
                            const imageRef = storage.refFromURL(oldImageUrl);
                            await imageRef.delete();
                        } catch (e) {
                            console.warn("Aviso: Imagem antiga n√£o foi exclu√≠da ou n√£o existe no Storage.", e.code);
                        }
                    }
                };

                const startEdit = (product) => {
                    newProduct.value = { ...product, price: parseFloat(product.price) }; 
                    imagePreviewUrl.value = product.imageUrl;
                    imageFile.value = null;
                    currentView.value = 'register';
                    clearFeedback();
                };

                const handleProductRegister = async () => {
                    isRegistering.value = true;
                    clearFeedback();

                    if (!imageFile.value) {
                        setFeedback('error', "Selecione uma imagem para o novo produto.");
                        isRegistering.value = false;
                        return;
                    }
                    
                    try {
                        const imageUrl = await uploadImage(imageFile.value);
                        
                        const productData = {
                            name: newProduct.value.name,
                            price: parseFloat(newProduct.value.price).toFixed(2), 
                            imageUrl: imageUrl || ''
                        };

                        await database.ref('produtos').push(productData);
                        
                        setFeedback('success', `Produto "${productData.name}" cadastrado com sucesso!`);
                        resetFormAndNavigate('admin');
                    } catch (err) {
                        setFeedback('error', 'Erro ao cadastrar produto.');
                        console.error("Erro no cadastro:", err);
                    } finally {
                        isRegistering.value = false;
                    }
                };

                const handleProductUpdate = async () => {
                    isRegistering.value = true;
                    clearFeedback();
                    let imageUrl = newProduct.value.imageUrl;
                    
                    const oldProduct = products.value.find(p => p.id === newProduct.value.id);
                    const oldImageUrl = oldProduct ? oldProduct.imageUrl : null;
                    
                    try {
                        if (imageFile.value) {
                            imageUrl = await uploadImage(imageFile.value);
                            await deleteOldImage(oldImageUrl);
                        } else if (!imageUrl) {
                            setFeedback('error', "O produto deve ter uma imagem.");
                            isRegistering.value = false;
                            return;
                        }
                        
                        const productData = {
                            name: newProduct.value.name,
                            price: parseFloat(newProduct.value.price).toFixed(2),
                            imageUrl: imageUrl
                        };

                        await database.ref('produtos/' + newProduct.value.id).update(productData);
                        
                        setFeedback('success', `Produto "${productData.name}" atualizado com sucesso!`);
                        resetFormAndNavigate('admin');
                    } catch (err) {
                        setFeedback('error', 'Erro ao atualizar produto.');
                        console.error("Erro na atualiza√ß√£o:", err);
                    } finally {
                        isRegistering.value = false;
                    }
                };

                const handleProductDelete = async (id, imageUrl) => {
                    if (confirm('Tem certeza que deseja excluir este produto? Esta a√ß√£o √© irrevers√≠vel.')) {
                        clearFeedback();
                        try {
                            await deleteOldImage(imageUrl);
                            await database.ref('produtos/' + id).remove();

                            setFeedback('success', 'Produto exclu√≠do com sucesso!');
                            products.value = products.value.filter(p => p.id !== id);
                        } catch (err) {
                            setFeedback('error', 'Erro ao excluir produto.');
                            console.error("Erro na exclus√£o:", err);
                        }
                    }
                };

                // --- 7. M√âTODOS DE PEDIDOS (CRUD) ---

           const updateOrderStatus = async (order, newStatus) => {
                    if (!order.clientUid || !order.id) {
                        setFeedback('error', 'Erro: UID do cliente ou ID do pedido n√£o encontrado.');
                        return;
                    }

                    const confirmationMessage = `Tem certeza que deseja mudar o status do pedido #${order.id.substring(0, 8).toUpperCase()} para "${newStatus}"?`;

                    if (confirm(confirmationMessage)) {
                        clearFeedback();
                        
                        let updateData = { status: newStatus };
                        const now = new Date().toLocaleString('pt-BR'); 

                        // Limpa todas as datas de status e define a nova
                        updateData.dateSent = null;
                        updateData.dateCanceled = null;
                        updateData.dateConcluded = null;

                        if (newStatus === 'Enviado') {
                            updateData.dateSent = now;
                        } else if (newStatus === 'Cancelado') {
                            updateData.dateCanceled = now;
                        } else if (newStatus === 'Conclu√≠do') { 
                            updateData.dateConcluded = now;
                        }
                        
                        // Garante que 'Processando' limpe todas as datas de status
                        if (newStatus === 'Processando') {
                            updateData.status = null; // Salva como nulo/vazio no DB
                        } else {
                            updateData.status = newStatus;
                        }

                        try {
                            const orderRef = database.ref(`pedidos/${order.clientUid}/${order.id}`);
                            await orderRef.update(updateData);
                            
                            // Atualiza o objeto local com os novos dados
                            const orderIndex = orders.value.findIndex(o => o.id === order.id);
                            if (orderIndex !== -1) {
                                // Precisa garantir que o status seja processando se o valor for nulo
                                const finalStatus = updateData.status || 'Processando';
                                // Cria um novo objeto de pedido atualizado para garantir reatividade
                                const updatedOrder = { ...orders.value[orderIndex], ...updateData, status: finalStatus }; 
                                orders.value.splice(orderIndex, 1, updatedOrder); // Atualiza na lista reativa
                                
                                // Re-processa os dados para atualizar o gr√°fico e a tabela
                                processMonthlyOrders(orders.value);
                                processTopSellingItems(orders.value);
                            }
                            
                            // Adiciona um feedback de sucesso inicial 
                            setFeedback('success', `Status do pedido #${order.id.substring(0, 8).toUpperCase()} atualizado para "${newStatus}".`);


                            // ----------------------------------------------------
                            // L√ìGICA DE WHATSAPP
                            // ----------------------------------------------------
                            
                            const customerName = order.customer.name || 'Cliente';
                            // Tenta obter o WhatsApp do campo 'phone' ou 'whatsapp', tratando e limpando o n√∫mero
                            const rawWhatsapp = order.customer.whatsapp || order.customer.phone || '';
                            const customerWhatsapp = rawWhatsapp.replace(/[^0-9]/g, ''); 
                            
                            const orderIdShort = order.id.substring(0, 8).toUpperCase();
                            const totalFormatted = formatPrice(order.total);
                            
                            // Cria a lista de itens, garantindo que order.items √© um array
                            const itemsArray = Array.isArray(order.items) ? order.items : (order.items ? Object.values(order.items) : []);
                            const orderItemsList = itemsArray.map(item => `  - ${item.name} (x${item.quantity})`).join('\n');
                            
                            if (customerWhatsapp.length >= 8) { // Checa se tem um n√∫mero v√°lido (pelo menos 8 d√≠gitos)
                                let messageText = '';
                                
                                if (newStatus === 'Enviado') {
                                    messageText = 
                                        `*üéâ √ìTIMA NOT√çCIA, ${customerName}! üéâ*\n\n` +
                                        `Seu pedido *#${orderIdShort}* foi *EMBALADO e ENVIADO*! üöÄ\n\n` +
                                        `*Detalhes do Pedido:*\n` +
                                        `üì¶ Itens:\n${orderItemsList}\n` + 
                                        `üí∞ Valor Total: ${totalFormatted}\n\n` +
                                        `üöö Status: ENVIADO\n` +
                                        `üìÖ Data do Envio: ${now}\n\n` +
                                        `*Agradecemos a sua compra e prefer√™ncia. Fique de olho na entrega!* üòä`;

                                } else if (newStatus === 'Cancelado') {
                                    messageText = 
                                        `*‚ùå Pedido Cancelado - ${customerName} *\n\n` +
                                        `Lamentamos informar, mas seu pedido *#${orderIdShort}* foi *CANCELADO*.\n\n` +
                                        `Detalhes:\n` +
                                        `üìÖ Data do Cancelamento: ${now}\n\n` +
                                        `Se foi um engano ou se precisar de ajuda para refazer a compra, por favor, responda esta mensagem. Estamos aqui para ajudar! üôè`;
                                        
                                } else if (newStatus === 'Conclu√≠do') { 
                                    messageText = 
                                        `*‚úÖ PEDIDO CONCLU√çDO! Obrigado, ${customerName}!* üôè\n\n` +
                                        `Confirmamos que seu pedido *#${orderIdShort}* foi finalizado com sucesso! Esperamos que tenha gostado dos seus produtos. ‚ú®\n\n` +
                                        `*Resumo:*\n` +
                                        `üì¶ Itens:\n${orderItemsList}\n` + 
                                        `üí∞ Valor Total: ${totalFormatted}\n\n` +
                                        `*Agradecemos a sua confian√ßa e volte sempre para mais novidades!* üòâ`;
                                }
                                
                                if (messageText) {
                                    const encodedMessage = encodeURIComponent(messageText);
                                    const whatsappUrl = `https://wa.me/55${customerWhatsapp}?text=${encodedMessage}`;
                                    // Abre o WhatsApp Web/App na janela do navegador
                                    window.open(whatsappUrl, '_blank');
                                    // Feedback extra para o admin 
                                    setFeedback('success', `Status do pedido atualizado para "${newStatus}". Abrindo WhatsApp para notificar ${customerName}.`);
                                }
                            } else if (newStatus === 'Enviado' || newStatus === 'Cancelado' || newStatus === 'Conclu√≠do') {
                                // Se o status √© um dos que gera notifica√ß√£o, mas o n√∫mero √© inv√°lido
                                alert(`Pedido atualizado para "${newStatus}". O WhatsApp N√ÉO foi aberto, pois o n√∫mero de contato do cliente √© inv√°lido ou n√£o foi fornecido.`);
                            }
                            // ----------------------------------------------------
                            // FIM DA L√ìGICA DE WHATSAPP
                            // ----------------------------------------------------


                        } catch (err) {
                            setFeedback('error', `Erro ao atualizar status para ${newStatus}.`);
                            console.error("Erro na atualiza√ß√£o de status:", err);
                        }
                    }
                };


                // Esta fun√ß√£o agora √© para EXCLUIR PERMANENTEMENTE DO BANCO DE DADOS.
                const handleOrderDelete = async (orderId, clientUid) => {
                    if (!clientUid) {
                         setFeedback('error', 'Erro: UID do cliente n√£o encontrado para exclus√£o.');
                         return;
                    }

                    if (confirm('ATEN√á√ÉO! Tem certeza que deseja EXCLUIR PERMANENTEMENTE este pedido do banco de dados? Esta a√ß√£o √© irrevers√≠vel.')) {
                        clearFeedback();
                        try {
                            await database.ref(`pedidos/${clientUid}/${orderId}`).remove();
                            
                            setFeedback('success', 'Pedido exclu√≠do permanentemente com sucesso!');
                            orders.value = orders.value.filter(o => o.id !== orderId);
                            // Re-processa os dados para atualizar o gr√°fico de relat√≥rios
                            updateReports(); // Usa o novo m√©todo de atualiza√ß√£o
                        } catch (err) {
                            setFeedback('error', 'Erro ao excluir pedido permanentemente.');
                            console.error("Erro na exclus√£o do pedido:", err);
                        }
                    }
                };


                // --- 8. LIFECYCLE HOOKS ---

                onMounted(() => {
                    auth.onAuthStateChanged((currentUser) => {
                        user.value = currentUser;
                        if (currentUser) {
                            currentView.value = 'admin';
                            fetchProducts(); 
                            fetchOrders();
                            clearFeedback();
                        } else {
                            currentView.value = 'login';
                        }
                    });
                    
                    // NOVO: Observa mudan√ßas no filtro de data (que muda filteredOrdersForReport) e atualiza os relat√≥rios
                    watch(filteredOrdersForReport, updateReports);
                });


                // --- 9. EXPOSI√á√ÉO PARA O TEMPLATE ---
                return {
                    user, email, password, error, isLoading, currentView, 
                    globalSuccess, globalError, products, isDataLoading, isRegistering,
                    newProduct, imageFile, uploadProgress, imagePreviewUrl, isEditing,
                    orders, isOrdersLoading, newAdmin, searchTerm, filteredProducts, 
                    orderFilter, filteredOrders, monthlyOrdersData, topSellingItems, totalRevenue, 
                    startDate, endDate, // EXPOSTO
                    
                    handleLogin, handleLogout, handleAdminRegister,
                    handleFileChange, startEdit, handleProductRegister,
                    handleProductUpdate, handleProductDelete, 
                    updateOrderStatus,
                    handleOrderDelete,
                    resetFormAndNavigate,
                    formatPrice, formatDate,
                    updateReports, clearDateFilters // EXPOSTO
                };
            }
        });
        
        // REGISTRA O NOVO COMPONENTE GLOBALMENTE
        app.component('chart-component', ChartComponent);
        
        app.mount('#app');
    </script>
</body>
</html>